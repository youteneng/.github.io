<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>è‚¾ç—…è¥å…»å¸ˆ Â· ä¼˜ç‰¹èƒ½</title>
    <style>
        /* å…¨å±€æ ·å¼ï¼Œä¸»è‰²è°ƒ #4a90e2 */
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background:#eef3f8; min-height:100vh; display:flex; justify-content:center; padding:12px; }
        #app { max-width:500px; width:100%; background:white; border-radius:32px; box-shadow:0 20px 40px rgba(0,20,40,0.15); padding:20px 16px 30px; position:relative; }
        h1 { font-size:32px; color:#0b4b6b; margin-bottom:8px; display:flex; align-items:center; gap:6px; font-weight:700; }
        .sub {
            background: #4a90e2;
            color: white;
            font-size: 18px;
            font-weight: 700;
            padding: 14px 18px;
            border-radius: 40px;
            margin: 10px 0 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(74,144,226,0.3);
            letter-spacing: 0.5px;
        }
        .disclaimer { background:#fef7e7; border-left:6px solid #e6a017; padding:12px 16px; border-radius:24px; font-size:13px; color:#8a6d2b; margin:15px 0; font-weight:500; }
        .nav { display:flex; justify-content:space-around; background:#f0f7fc; border-radius:40px; padding:6px; margin:20px 0 16px; border:1px solid #cbddec; }
        .nav-item { flex:1; text-align:center; padding:10px 0; border-radius:30px; font-weight:600; color:#2a5f82; cursor:pointer; transition:0.2s; }
        .nav-item.active { background:#4a90e2; color:white; box-shadow:0 4px 8px rgba(74,144,226,0.3); }
        .page { display:none; }
        .page.active { display:block; }
        .card { background:#f8fbfe; border-radius:28px; padding:20px 16px; border:1px solid #d2e3f0; margin:16px 0; }
        .label { font-weight:700; color:#1a4b6d; font-size:18px; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
        .input-row { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
        .input-group { flex:1 1 130px; }
        .input-group label { font-size:14px; color:#3a627d; display:block; margin-bottom:4px; }
        input, select { width:100%; padding:14px 16px; border:1px solid #c2d6e6; border-radius:30px; font-size:16px; background:white; }
        .radio-group { display:flex; gap:20px; background:white; padding:10px 16px; border-radius:30px; border:1px solid #c2d6e6; }
        .btn { width:100%; background:#4a90e2; color:white; font-size:18px; font-weight:700; padding:16px; border:none; border-radius:50px; margin:12px 0; cursor:pointer; box-shadow:0 8px 16px rgba(74,144,226,0.3); }
        .btn:active { background:#3a78c2; }
        .btn-small { background:#e1eefb; color:#4a90e2; font-size:16px; padding:10px; border-radius:30px; border:none; cursor:pointer; }
        .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin:15px 0; }
        .nutri-card { background:white; border-radius:18px; padding:12px 4px; text-align:center; border:1px solid #d4e2ee; }
        .nutri-card .value { font-size:24px; font-weight:700; color:#0b4b6b; }
        .food-table { background:white; border-radius:24px; border:1px solid #d0e2f0; margin:16px 0; }
        .food-row { display:flex; justify-content:space-between; padding:14px 18px; border-bottom:1px dashed #c7ddec; }
        .food-row:last-child { border-bottom:none; }
        .food-row span:first-child { white-space: nowrap; margin-right: 8px; flex-shrink: 0; }
        .food-row span:last-child { text-align: right; word-break: break-word; font-size: 0.92em; color: #1a4b6d; }
        .warning { background:#ffefed; border-left:6px solid #c0392b; padding:16px; border-radius:24px; color:#a13024; font-weight:500; margin:20px 0; }
        .progress-bar { background:#e0eefb; height:24px; border-radius:30px; margin:8px 0; overflow:hidden; }
        .progress-fill { height:100%; background:#4a90e2; color:white; font-size:13px; line-height:24px; padding-left:10px; white-space:nowrap; }
        .history-item { background:white; border-radius:20px; padding:16px; margin-bottom:10px; border:1px solid #d0e2f0; }
        .slider-panel { background:#e9f2fa; border-radius:28px; padding:18px; margin:16px 0; border:1px solid #bdd6e8; }
        .slider-item { margin-bottom:16px; }
        .slider-item label { display:flex; justify-content:space-between; font-weight:600; color:#1a4b6d; }
        .slider-item input[type=range] { width:100%; margin:8px 0; -webkit-appearance:none; height:8px; background:#d0e0f0; border-radius:10px; outline:none; }
        .slider-item input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; background:#4a90e2; border-radius:50%; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
        .slider-value { font-weight:700; color:#0b4b6d; }
        .slider-actions { display:flex; gap:10px; margin-top:16px; }
        .slider-actions button { flex:1; }
        .footnote { text-align:center; font-size:12px; color:#7b93aa; margin-top:20px; }
        .qr-area { text-align:center; margin-top:20px; padding:12px 0; border-top:1px dashed #c7ddec; }
        .qr-img { width:100px; height:100px; border-radius:16px; border:2px solid #4a90e2; object-fit: cover; }
        .qr-text { font-size:12px; color:#4a90e2; font-weight:500; margin-top:6px; }
        .qr-sub { font-size:10px; color:#999; margin-top:2px; }
    </style>
    <!-- ç™¾åº¦ç»Ÿè®¡ä»£ç  - åˆå§‹åŒ–æ•°ç»„ï¼ˆå¿…é¡»ä¿ç•™ï¼Œä¾›äº‹ä»¶åŸ‹ç‚¹ä½¿ç”¨ï¼‰ -->
    <script>
    var _hmt = _hmt || [];
    // é¡µé¢åŠ è½½å®Œæˆåå‘é€ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼Œç”¨äºéªŒè¯ç»Ÿè®¡æ˜¯å¦å·¥ä½œï¼ˆå¯é€‰ï¼‰
    window.addEventListener('load', function() {
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'ç³»ç»Ÿ', 'é¡µé¢åŠ è½½', 'å®Œæˆ']);
        }
    });
    </script>
</head>
<body>
<div id="app">
    <h1>ğŸ§ª è‚¾ç—…è¥å…»å¸ˆ</h1>
    <div class="sub">ä¼˜ç‰¹èƒ½Â·æ‚¨çš„è‚¾ç—…é¥®é£ŸåŠ©æ‰‹</div>
    <div class="disclaimer">
        âš ï¸ æœ¬å·¥å…·ä»…ä¾›è¾…åŠ©å‚è€ƒï¼Œæ‰€æœ‰è®¡ç®—ç»“æœå‡åŸºäºé€šç”¨åŒ»å­¦æŒ‡å—ï¼Œä¸èƒ½æ›¿ä»£æ‰§ä¸šåŒ»å¸ˆçš„ä¸ªæ€§åŒ–è¯Šæ–­ä¸æ²»ç–—å»ºè®®ã€‚è¯·åŠ¡å¿…éµåŒ»å˜±ï¼Œå¹¶ç»“åˆè‡ªèº«æƒ…å†µè°ƒæ•´é¥®é£Ÿã€‚
    </div>
    <div class="nav">
        <div class="nav-item active" data-page="profile">æ¡£æ¡ˆ</div>
        <div class="nav-item" data-page="target">ç›®æ ‡</div>
        <div class="nav-item" data-page="recipe">é£Ÿè°±</div>
        <div class="nav-item" data-page="record">è®°å½•</div>
    </div>

    <!-- æ¡£æ¡ˆé¡µ -->
    <div id="profile-page" class="page active">
        <div class="card">
            <div class="label">ğŸ§‘â€âš•ï¸ æˆ‘çš„æ¡£æ¡ˆ</div>
            <div class="radio-group" style="margin-bottom: 16px;">
                <label><input type="radio" name="gender" value="male" checked> ç”·</label>
                <label><input type="radio" name="gender" value="female"> å¥³</label>
            </div>
            <div class="input-row">
                <div class="input-group"><label>èº«é«˜ (cm)</label><input type="number" id="height" value="170" step="1"></div>
                <div class="input-group"><label>ä½“é‡ (kg)</label><input type="number" id="weight" value="70" step="0.1"></div>
            </div>
            <div class="input-group" style="margin-bottom: 16px;">
                <label>CKDåˆ†æœŸ</label>
                <select id="ckdStage">
                    <option value="3">CKD 3æœŸ (GFR 30-59)</option>
                    <option value="4">CKD 4æœŸ (GFR 15-29)</option>
                    <option value="5" selected>CKD 5æœŸ (GFR <15, æœªé€æ)</option>
                </select>
            </div>
            <div class="input-row">
                <div class="input-group"><label>è¡€é’¾ (mmol/L)</label><input type="number" id="bloodK" value="4.5" step="0.1"></div>
                <div class="input-group"><label>è¡€ç£· (mmol/L)</label><input type="number" id="bloodP" value="1.3" step="0.1"></div>
            </div>
            <div class="input-row" style="align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px; width: 100%;">
                    <input type="checkbox" id="edema" style="width: auto; margin: 0;">
                    <span>æœ‰æµ®è‚¿/é«˜è¡€å‹</span>
                </label>
            </div>
            <button class="btn" id="saveProfile">ä¿å­˜æ¡£æ¡ˆå¹¶ç”Ÿæˆç›®æ ‡</button>
        </div>
        <div class="disclaimer" style="margin-top:0;">ğŸ‘‰ è¯·ç¡®ä¿åŒ–éªŒæ•°æ®å‡†ç¡®ï¼Œå¹¶å®šæœŸå’¨è¯¢åŒ»ç”Ÿè°ƒæ•´æ–¹æ¡ˆã€‚</div>
    </div>

    <!-- ç›®æ ‡é¡µ -->
    <div id="target-page" class="page">
        <div class="card">
            <div class="label">ğŸ“Š ä»Šæ—¥è¥å…»ç›®æ ‡</div>
            <div id="targetIdealWeight" style="font-size:16px; color:#2f607c; margin-bottom:10px;"></div>
            <div class="grid-3" id="targetGrid"></div>
            <button class="btn" id="gotoRecipeFromTarget">ç”Ÿæˆé£Ÿè°± â†’</button>
        </div>
    </div>

    <!-- é£Ÿè°±é¡µ -->
    <div id="recipe-page" class="page">
        <div class="card">
            <div class="label">ğŸ¥— æ¯æ—¥é£Ÿç‰©äº¤æ¢ä»½</div>
            <div id="sharesTable" class="food-table"></div>
            <div class="label" style="margin-top:20px;">ğŸ½ï¸ æ¨èé£Ÿè°±ç¤ºä¾‹</div>
            <div id="recipeExample" class="food-table"></div>
            <div style="display: flex; gap: 8px; margin: 16px 0;">
                <button class="btn" id="useRecipeForToday" style="flex:1;">ä½¿ç”¨æ­¤é£Ÿè°±è®°å½•ä»Šæ—¥</button>
                <button class="btn" id="gotoRecord" style="flex:1;">å»è®°å½•é¡µ</button>
            </div>
        </div>
    </div>

    <!-- è®°å½•é¡µ -->
    <div id="record-page" class="page">
        <div class="card">
            <div class="label">ğŸ“… ä»Šæ—¥é¥®é£Ÿè®°å½•</div>
            <div id="dateDisplay" style="text-align:right; color:#2f607c;"></div>
            <div id="recordTargetSummary" style="font-size:14px; margin:10px 0;"></div>
            <div id="recordProgress"></div>
            <div id="recordWarning" class="warning" style="display:none;"></div>

            <div id="sliderPanel" class="slider-panel" style="display:none;">
                <div style="font-weight:700; margin-bottom:12px;">è°ƒæ•´å„ç±»é£Ÿç‰©ä»½æ•°</div>
                <div class="slider-item"><label>ğŸ¥› ä¹³åˆ¶å“ <span id="dairyVal" class="slider-value">1.0</span></label><input type="range" id="dairySlider" min="0" max="3" step="0.5" value="1"></div>
                <div class="slider-item"><label>ğŸ— è‚‰é±¼ç¦½è›‹ <span id="meatVal" class="slider-value">1.0</span></label><input type="range" id="meatSlider" min="0" max="5" step="0.5" value="1"></div>
                <div class="slider-item"><label>ğŸ¥¬ è”¬èœ <span id="vegVal" class="slider-value">4.0</span></label><input type="range" id="vegSlider" min="0" max="8" step="0.5" value="4"></div>
                <div class="slider-item"><label>ğŸ æ°´æœ <span id="fruitVal" class="slider-value">2.0</span></label><input type="range" id="fruitSlider" min="0" max="5" step="0.5" value="2"></div>
                <div class="slider-item"><label>ğŸš è°·ç±»ä¸»é£Ÿ <span id="grainVal" class="slider-value">2.0</span></label><input type="range" id="grainSlider" min="0" max="8" step="0.5" value="2"></div>
                <div class="slider-item"><label>ğŸ§ˆ æ²¹è„‚ç±» <span id="oilVal" class="slider-value">5.0</span></label><input type="range" id="oilSlider" min="0" max="10" step="0.5" value="5"></div>
                <div class="slider-item"><label>ğŸ  ä½è›‹ç™½æ·€ç²‰ <span id="starchVal" class="slider-value">2.0</span></label><input type="range" id="starchSlider" min="0" max="10" step="0.5" value="2"></div>
                <div class="slider-actions"><button class="btn-small" id="saveSlider">ä¿å­˜è°ƒæ•´</button><button class="btn-small" id="cancelSlider">å–æ¶ˆ</button></div>
            </div>

            <div style="margin: 16px 0;"><button class="btn" id="showSliderBtn">ğŸ“Š è°ƒæ•´æ‘„å…¥</button></div>
            <div class="label" style="margin-top:20px;">ğŸ“š å†å²è®°å½•</div>
            <div id="historyList"></div>
        </div>
    </div>

    <div class="footnote">âš ï¸ æœ¬å·¥å…·ä¸ºè¾…åŠ©å‚è€ƒï¼Œä¸æ›¿ä»£åŒ»å˜±ã€‚</div>
    <div class="qr-area">
        <img class="qr-img" src="https://i.ibb.co/60zLWcbY/qrcode-for-gh-cf3480e4ed67-258.jpg" alt="ä¼˜ç‰¹èƒ½å…¬ä¼—å·äºŒç»´ç ">
        <div class="qr-text">æ‰«ç å…³æ³¨ä¼˜ç‰¹èƒ½</div>
        <div class="qr-sub">è·å–æ›´å¤šè‚¾ç—…é¥®é£ŸçŸ¥è¯†</div>
    </div>
</div>

<!-- ç™¾åº¦ç»Ÿè®¡è„šæœ¬ - æ”¾åœ¨bodyç»“æŸå‰ï¼ˆç¬¦åˆç™¾åº¦æ£€æŸ¥è¦æ±‚ï¼‰ -->
<script>
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?518c1a8f2fbf8068280278370c342fce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
// ä»¥ä¸‹ä¸ºå®Œæ•´çš„æ ¸å¿ƒé€»è¾‘ï¼ˆåŒ…å«æ‰€æœ‰é˜²å¾¡æ€§æ›´æ–°å’Œç™¾åº¦ç»Ÿè®¡äº‹ä»¶åŸ‹ç‚¹ï¼‰
const FOOD_DB = {
    dairy: [
        { name: "å…¨è„‚å¥¶", weight: 130, protein: 4, energy: 80, sodium: 70, potassium: 135, phosphorus: 110 },
        { name: "è„±è„‚é…¸å¥¶", weight: 120, protein: 4, energy: 68, sodium: 70, potassium: 187, phosphorus: 109 }
    ],
    meat: [
        { name: "é¸¡è›‹", weight: 55, protein: 7, energy: 85, sodium: 69, potassium: 146, phosphorus: 100 },
        { name: "ç˜¦çŒªè‚‰", weight: 35, protein: 7, energy: 65, sodium: 50, potassium: 100, phosphorus: 65 },
        { name: "æ¸…è’¸é²ˆé±¼", weight: 55, protein: 7, energy: 73, sodium: 50, potassium: 100, phosphorus: 65 }
    ],
    grain: [
        { name: "ç±³é¥­", weight: 60, protein: 2, energy: 80, sodium: 20, potassium: 35, phosphorus: 35 },
        { name: "é¦’å¤´", weight: 30, protein: 2, energy: 80, sodium: 20, potassium: 35, phosphorus: 35 }
    ],
    veg: {
        low: [
            { name: "å†¬ç“œ", weight: 200, protein: 1, energy: 15, sodium: 20, potassium: 78, phosphorus: 25 },
            { name: "é»„ç“œ", weight: 150, protein: 1, energy: 15, sodium: 20, potassium: 89, phosphorus: 25 }
        ],
        medium: [
            { name: "èŒ„å­", weight: 100, protein: 1, energy: 15, sodium: 20, potassium: 136, phosphorus: 25 },
            { name: "ç•ªèŒ„", weight: 100, protein: 1, energy: 15, sodium: 20, potassium: 163, phosphorus: 25 }
        ],
        high: [
            { name: "è èœ", weight: 100, protein: 1, energy: 15, sodium: 20, potassium: 248, phosphorus: 25 },
            { name: "åœŸè±†", weight: 50, protein: 1, energy: 15, sodium: 20, potassium: 224, phosphorus: 25 }
        ]
    },
    fruit: {
        low: [
            { name: "è‹¹æœ", weight: 110, protein: 1, energy: 65, sodium: 0, potassium: 115, phosphorus: 20 },
            { name: "æ¢¨", weight: 150, protein: 1, energy: 65, sodium: 0, potassium: 116, phosphorus: 20 }
        ],
        medium: [
            { name: "æ©˜å­", weight: 120, protein: 1, energy: 65, sodium: 0, potassium: 157, phosphorus: 20 },
            { name: "çŒ•çŒ´æ¡ƒ", weight: 120, protein: 1, energy: 65, sodium: 0, potassium: 217, phosphorus: 20 }
        ],
        high: [
            { name: "é¦™è•‰", weight: 70, protein: 1, energy: 65, sodium: 0, potassium: 256, phosphorus: 20 }
        ]
    },
    oil: [
        { name: "èŠ±ç”Ÿæ²¹", weight: 5, protein: 0, energy: 45, sodium: 10, potassium: 10, phosphorus: 5 }
    ],
    starch: [
        { name: "è—•ç²‰", weight: 15, protein: 0.2, energy: 60, sodium: 0, potassium: 20, phosphorus: 5 }
    ]
};

const AVG_NUTRI = {
    dairy: { protein:4, energy:80, sodium:70, potassium:135, phosphorus:110 },
    meat:  { protein:7, energy:65, sodium:50, potassium:100, phosphorus:65 },
    grain: { protein:2, energy:80, sodium:20, potassium:35, phosphorus:35 },
    veg:   { protein:1, energy:15, sodium:20, potassium:150, phosphorus:25 },
    fruit: { protein:1, energy:65, sodium:0,  potassium:200, phosphorus:20 },
    oil:   { protein:0, energy:45, sodium:10, potassium:10, phosphorus:5 },
    starch:{ protein:0.2, energy:60, sodium:0, potassium:20, phosphorus:5 }
};

let currentProfile = null;
let currentTarget = null;
let currentShares = null;
let todayRecord = null;
let historyRecords = [];

const STORAGE_KEYS = {
    PROFILE: 'nephro_profile',
    TARGET: 'nephro_target',
    SHARES: 'nephro_shares',
    TODAY: 'nephro_today',
    HISTORY: 'nephro_history'
};

function loadFromStorage() {
    try {
        let p = localStorage.getItem(STORAGE_KEYS.PROFILE);
        if (p) currentProfile = JSON.parse(p);
        let t = localStorage.getItem(STORAGE_KEYS.TARGET);
        if (t) currentTarget = JSON.parse(t);
        let s = localStorage.getItem(STORAGE_KEYS.SHARES);
        if (s) currentShares = JSON.parse(s);
        let td = localStorage.getItem(STORAGE_KEYS.TODAY);
        if (td) todayRecord = JSON.parse(td);
        let hist = localStorage.getItem(STORAGE_KEYS.HISTORY);
        if (hist) historyRecords = JSON.parse(hist); else historyRecords = [];
        let todayStr = new Date().toLocaleDateString('zh-CN');
        if (todayRecord && todayRecord.date !== todayStr) {
            if (todayRecord) historyRecords.unshift(todayRecord);
            todayRecord = null;
            localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(historyRecords));
            localStorage.removeItem(STORAGE_KEYS.TODAY);
        }
    } catch (e) { console.warn('è¯»å–å­˜å‚¨å¤±è´¥', e); }
}
function saveProfile() { try { localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(currentProfile)); } catch(e) {} }
function saveTarget() { try { localStorage.setItem(STORAGE_KEYS.TARGET, JSON.stringify(currentTarget)); } catch(e) {} }
function saveShares() { try { localStorage.setItem(STORAGE_KEYS.SHARES, JSON.stringify(currentShares)); } catch(e) {} }
function saveToday() { try { if (todayRecord) localStorage.setItem(STORAGE_KEYS.TODAY, JSON.stringify(todayRecord)); else localStorage.removeItem(STORAGE_KEYS.TODAY); } catch(e) {} }
function saveHistory() { try { localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(historyRecords)); } catch(e) {} }

function computeTargetAndShares(profile) {
    let idealWeight = profile.gender === 'male' ? profile.height - 105 : profile.height - 107;
    idealWeight = Math.round(idealWeight * 10) / 10;
    let proteinFactor = profile.ckdStage == 5 ? 0.4 : 0.6;
    let proteinTotal = Math.round(idealWeight * proteinFactor * 10) / 10;
    let proteinHQ = Math.round(proteinTotal * 0.6 * 10) / 10;
    let energy = Math.round(idealWeight * 35);
    let sodium = profile.edema ? 1500 : 2000;
    let potassium = Math.round(idealWeight * 40);
    let phosphorus = Math.round(idealWeight * 10);
    const target = { idealWeight, proteinTotal, proteinHQ, energy, sodium, potassium, phosphorus };

    let milkShares = 1;
    let remainHQ = proteinHQ - milkShares * AVG_NUTRI.dairy.protein;
    let meatShares = Math.max(0, remainHQ / AVG_NUTRI.meat.protein);
    meatShares = Math.round(meatShares * 2) / 2;
    let vegShares = 4;
    let fruitShares = 2;
    let nonHQFromVegFruit = vegShares * AVG_NUTRI.veg.protein + fruitShares * AVG_NUTRI.fruit.protein;
    let nonHQTarget = proteinTotal - proteinHQ;
    let grainShares = Math.max(0, (nonHQTarget - nonHQFromVegFruit) / AVG_NUTRI.grain.protein);
    grainShares = Math.round(grainShares * 2) / 2;
    let energySoFar = milkShares * AVG_NUTRI.dairy.energy + meatShares * AVG_NUTRI.meat.energy +
                      vegShares * AVG_NUTRI.veg.energy + fruitShares * AVG_NUTRI.fruit.energy +
                      grainShares * AVG_NUTRI.grain.energy;
    let oilShares = 5;
    let energyWithOil = energySoFar + oilShares * AVG_NUTRI.oil.energy;
    let energyRemain = energy - energyWithOil;
    let starchShares = 0;
    if (energyRemain > 0) {
        starchShares = energyRemain / AVG_NUTRI.starch.energy;
        starchShares = Math.round(starchShares * 2) / 2;
    } else {
        oilShares = Math.max(0, oilShares + Math.floor(energyRemain / AVG_NUTRI.oil.energy));
        energyRemain = energy - (energySoFar + oilShares * AVG_NUTRI.oil.energy);
        if (energyRemain > 0) starchShares = Math.round(energyRemain / AVG_NUTRI.starch.energy * 2) / 2;
    }
    const shares = { milk: milkShares, meat: meatShares, veg: vegShares, fruit: fruitShares, grain: grainShares, oil: oilShares, starch: starchShares };
    return { target, shares };
}

function showPage(pageId) {
    try {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId + '-page');
        if (!targetPage) { console.error('é¡µé¢ä¸å­˜åœ¨:', pageId + '-page'); return; }
        targetPage.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.page === pageId) item.classList.add('active');
            else item.classList.remove('active');
        });
        if (pageId === 'target') renderTargetPage();
        if (pageId === 'recipe') renderRecipePage();
        if (pageId === 'record') renderRecordPage();

        // ç™¾åº¦ç»Ÿè®¡ï¼šè®°å½•é¡µé¢åˆ‡æ¢äº‹ä»¶ï¼ˆSPA åœºæ™¯ï¼‰
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'å¯¼èˆª', 'åˆ‡æ¢é¡µé¢', pageId]);
        }
    } catch (e) {
        console.error('é¡µé¢åˆ‡æ¢é”™è¯¯', e);
        alert('é¡µé¢åˆ‡æ¢æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚');
    }
}

function renderTargetPage() {
    const grid = document.getElementById('targetGrid');
    const idealSpan = document.getElementById('targetIdealWeight');
    if (!grid || !idealSpan) return;
    if (!currentTarget) {
        grid.innerHTML = '<div style="grid-column:span 3; text-align:center; padding:20px;">è¯·å…ˆåœ¨æ¡£æ¡ˆé¡µä¿å­˜æ¡£æ¡ˆ</div>';
        idealSpan.innerText = '';
        return;
    }
    idealSpan.innerText = `ç†æƒ³ä½“é‡ ${currentTarget.idealWeight} kg`;
    let html = `
        <div class="nutri-card"><span class="value">${currentTarget.proteinTotal}</span><span class="unit">g</span><div>è›‹ç™½è´¨</div></div>
        <div class="nutri-card"><span class="value">${currentTarget.proteinHQ}</span><span class="unit">g</span><div>ä¼˜è´¨è›‹ç™½</div></div>
        <div class="nutri-card"><span class="value">${currentTarget.energy}</span><span class="unit">kcal</span><div>èƒ½é‡</div></div>
        <div class="nutri-card"><span class="value">${currentTarget.sodium}</span><span class="unit">mg</span><div>é’ </div></div>
        <div class="nutri-card"><span class="value">${currentTarget.potassium}</span><span class="unit">mg</span><div>é’¾</div></div>
        <div class="nutri-card"><span class="value">${currentTarget.phosphorus}</span><span class="unit">mg</span><div>ç£·</div></div>
    `;
    grid.innerHTML = html;
}

function renderRecipePage() {
    const sharesDiv = document.getElementById('sharesTable');
    const recipeDiv = document.getElementById('recipeExample');
    if (!sharesDiv || !recipeDiv) return;
    if (!currentShares || !currentTarget || !currentProfile) {
        sharesDiv.innerHTML = '<div class="food-row">è¯·å…ˆä¿å­˜æ¡£æ¡ˆ</div>';
        recipeDiv.innerHTML = '';
        return;
    }
    let s = currentShares;
    let sharesHtml = `
        <div class="food-row"><span>ğŸ¥› ä¹³åˆ¶å“</span><span>${s.milk.toFixed(1)} ä»½</span></div>
        <div class="food-row"><span>ğŸ— è‚‰é±¼ç¦½è›‹</span><span>${s.meat.toFixed(1)} ä»½</span></div>
        <div class="food-row"><span>ğŸ¥¬ è”¬èœ</span><span>${s.veg} ä»½</span></div>
        <div class="food-row"><span>ğŸ æ°´æœ</span><span>${s.fruit} ä»½</span></div>
        <div class="food-row"><span>ğŸš è°·ç±»ä¸»é£Ÿ</span><span>${s.grain.toFixed(1)} ä»½</span></div>
        <div class="food-row"><span>ğŸ§ˆ æ²¹è„‚ç±»</span><span>${s.oil} ä»½</span></div>
        <div class="food-row"><span>ğŸ  ä½è›‹ç™½æ·€ç²‰</span><span>${s.starch.toFixed(1)} ä»½</span></div>
    `;
    sharesDiv.innerHTML = sharesHtml;

    let bloodK = currentProfile.bloodK || 4.5;
    let vegGroup = bloodK > 5.0 ? 'low' : (bloodK < 3.5 ? 'high' : 'medium');
    let fruitGroup = bloodK > 5.0 ? 'low' : (bloodK < 3.5 ? 'high' : 'medium');
    let dairyItem = FOOD_DB.dairy[0];
    let meatItem = FOOD_DB.meat[0];
    let grainItem = FOOD_DB.grain[0];
    let vegItem = FOOD_DB.veg[vegGroup][0];
    let fruitItem = FOOD_DB.fruit[fruitGroup][0];
    let starchItem = FOOD_DB.starch[0];

    let recipeHtml = `
        <div class="food-row"><span>ğŸŒ… æ—©é¤</span><span>${dairyItem.name} ${s.milk}ä»½ (${dairyItem.weight*s.milk}g) Â· ${grainItem.name} 1ä»½ (${grainItem.weight}g) Â· æ°´æœ: ${fruitItem.name} 1ä»½</span></div>
        <div class="food-row"><span>â˜€ï¸ åˆé¤</span><span>${meatItem.name} ${s.meat}ä»½ (${Math.round(meatItem.weight*s.meat)}g) Â· è”¬èœ: ${vegItem.name} 2ä»½</span></div>
        <div class="food-row"><span>ğŸŒ™ æ™šé¤</span><span>${meatItem.name} å‰©ä½™ Â· è”¬èœ: ${vegItem.name} 2ä»½ Â· ä¸»é£Ÿ: ${grainItem.name} ${Math.max(0, s.grain-1).toFixed(1)}ä»½</span></div>
        <div class="food-row"><span>ğŸª åŠ é¤</span><span>${starchItem.name} ${s.starch}ä»½ (${starchItem.weight*s.starch}g) Â· æ°´æœ: å‰©ä½™1ä»½</span></div>
    `;
    recipeDiv.innerHTML = recipeHtml;
}

function updateRecordDisplay() {
    const progressDiv = document.getElementById('recordProgress');
    const warningDiv = document.getElementById('recordWarning');
    const targetSummary = document.getElementById('recordTargetSummary');
    const dateDisplay = document.getElementById('dateDisplay');
    if (!progressDiv || !warningDiv || !targetSummary || !dateDisplay) return;
    
    if (!currentTarget || typeof currentTarget !== 'object') {
        progressDiv.innerHTML = 'è¯·å…ˆè®¾ç½®æ¡£æ¡ˆ';
        return;
    }
    if (currentTarget.proteinTotal === undefined || currentTarget.potassium === undefined || 
        currentTarget.phosphorus === undefined || currentTarget.sodium === undefined) {
        progressDiv.innerHTML = 'ç›®æ ‡æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ä¿å­˜æ¡£æ¡ˆ';
        return;
    }

    let todayStr = new Date().toLocaleDateString('zh-CN');
    dateDisplay.innerText = todayStr;
    targetSummary.innerHTML = `ç›®æ ‡: è›‹ç™½è´¨${currentTarget.proteinTotal}g, é’¾${currentTarget.potassium}mg, ç£·${currentTarget.phosphorus}mg, é’ ${currentTarget.sodium}mg`;

    if (!todayRecord || !todayRecord.intake) {
        todayRecord = { date: todayStr, intake: { dairy:0, meat:0, veg:0, fruit:0, grain:0, oil:0, starch:0 } };
    }

    let intake = todayRecord.intake;
    const defaultIntake = { dairy:0, meat:0, veg:0, fruit:0, grain:0, oil:0, starch:0 };
    intake = { ...defaultIntake, ...intake };

    let actualProtein = intake.dairy*AVG_NUTRI.dairy.protein + intake.meat*AVG_NUTRI.meat.protein +
                        intake.veg*AVG_NUTRI.veg.protein + intake.fruit*AVG_NUTRI.fruit.protein +
                        intake.grain*AVG_NUTRI.grain.protein + intake.oil*AVG_NUTRI.oil.protein +
                        intake.starch*AVG_NUTRI.starch.protein;
    let actualK = intake.dairy*AVG_NUTRI.dairy.potassium + intake.meat*AVG_NUTRI.meat.potassium +
                  intake.veg*AVG_NUTRI.veg.potassium + intake.fruit*AVG_NUTRI.fruit.potassium +
                  intake.grain*AVG_NUTRI.grain.potassium + intake.oil*AVG_NUTRI.oil.potassium +
                  intake.starch*AVG_NUTRI.starch.potassium;
    let actualP = intake.dairy*AVG_NUTRI.dairy.phosphorus + intake.meat*AVG_NUTRI.meat.phosphorus +
                  intake.veg*AVG_NUTRI.veg.phosphorus + intake.fruit*AVG_NUTRI.fruit.phosphorus +
                  intake.grain*AVG_NUTRI.grain.phosphorus + intake.oil*AVG_NUTRI.oil.phosphorus +
                  intake.starch*AVG_NUTRI.starch.phosphorus;
    let actualNa = intake.dairy*AVG_NUTRI.dairy.sodium + intake.meat*AVG_NUTRI.meat.sodium +
                  intake.veg*AVG_NUTRI.veg.sodium + intake.fruit*AVG_NUTRI.fruit.sodium +
                  intake.grain*AVG_NUTRI.grain.sodium + intake.oil*AVG_NUTRI.oil.sodium +
                  intake.starch*AVG_NUTRI.starch.sodium;

    let proteinPercent = Math.min(100, Math.round(actualProtein / currentTarget.proteinTotal * 100));
    let kPercent = Math.min(100, Math.round(actualK / currentTarget.potassium * 100));
    let pPercent = Math.min(100, Math.round(actualP / currentTarget.phosphorus * 100));
    let naPercent = Math.min(100, Math.round(actualNa / currentTarget.sodium * 100));

    let progressHtml = `
        <div style="margin:10px 0;">è›‹ç™½è´¨: ${actualProtein.toFixed(1)}/${currentTarget.proteinTotal}g</div>
        <div class="progress-bar"><div class="progress-fill" style="width:${proteinPercent}%;">${proteinPercent}%</div></div>
        <div>é’¾: ${actualK}/${currentTarget.potassium}mg</div>
        <div class="progress-bar"><div class="progress-fill" style="width:${kPercent}%;">${kPercent}%</div></div>
        <div>ç£·: ${actualP}/${currentTarget.phosphorus}mg</div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pPercent}%;">${pPercent}%</div></div>
        <div>é’ : ${actualNa}/${currentTarget.sodium}mg</div>
        <div class="progress-bar"><div class="progress-fill" style="width:${naPercent}%;">${naPercent}%</div></div>
    `;
    progressDiv.innerHTML = progressHtml;

    let warnings = [];
    if (actualK > currentTarget.potassium * 1.1) warnings.push('âš ï¸ é’¾æ‘„å…¥è¶…è¿‡ç›®æ ‡10%ï¼è¯·é€‰æ‹©ä½é’¾é£Ÿç‰©ã€‚');
    else if (actualK > currentTarget.potassium) warnings.push('âš ï¸ é’¾æ‘„å…¥ç•¥é«˜ã€‚');
    if (actualP > currentTarget.phosphorus * 1.1) warnings.push('âš ï¸ ç£·æ‘„å…¥è¶…è¿‡ç›®æ ‡10%ï¼è¯·é¿å…é«˜ç£·é£Ÿç‰©ã€‚');
    else if (actualP > currentTarget.phosphorus) warnings.push('âš ï¸ ç£·æ‘„å…¥ç•¥é«˜ã€‚');
    if (actualNa > currentTarget.sodium * 1.1) warnings.push('âš ï¸ é’ æ‘„å…¥è¶…è¿‡ç›®æ ‡10%ï¼è¯·å‡å°‘ç›/è°ƒå‘³å“ã€‚');
    else if (actualNa > currentTarget.sodium) warnings.push('âš ï¸ é’ æ‘„å…¥ç•¥é«˜ï¼Œæ³¨æ„æ¸…æ·¡ã€‚');
    if (actualProtein > currentTarget.proteinTotal * 1.05) warnings.push('âš ï¸ è›‹ç™½è´¨æ‘„å…¥è¶…æ ‡ã€‚');
    if (warnings.length) {
        warningDiv.style.display = 'block';
        warningDiv.innerHTML = warnings.join('<br>');
    } else {
        warningDiv.style.display = 'none';
    }

    const sliderMappings = [
        { id: 'dairySlider', valId: 'dairyVal', value: intake.dairy },
        { id: 'meatSlider', valId: 'meatVal', value: intake.meat },
        { id: 'vegSlider', valId: 'vegVal', value: intake.veg },
        { id: 'fruitSlider', valId: 'fruitVal', value: intake.fruit },
        { id: 'grainSlider', valId: 'grainVal', value: intake.grain },
        { id: 'oilSlider', valId: 'oilVal', value: intake.oil },
        { id: 'starchSlider', valId: 'starchVal', value: intake.starch }
    ];

    sliderMappings.forEach(item => {
        const slider = document.getElementById(item.id);
        const valSpan = document.getElementById(item.valId);
        if (slider) slider.value = item.value;
        if (valSpan) valSpan.innerText = item.value.toFixed(1);
    });
}

function renderRecordPage() {
    updateRecordDisplay();
    let historyDiv = document.getElementById('historyList');
    if (!historyDiv) return;
    let histHtml = '';
    historyRecords.slice(0,5).forEach((r, idx) => {
        let totalP = (r.intake.dairy*4 + r.intake.meat*7 + r.intake.veg*1 + r.intake.fruit*1 + r.intake.grain*2).toFixed(1);
        histHtml += `<div class="history-item">${r.date} è›‹ç™½è´¨æ‘„å…¥: ${totalP}g</div>`;
    });
    historyDiv.innerHTML = histHtml || 'æš‚æ— å†å²';
}

document.addEventListener('DOMContentLoaded', function() {
    loadFromStorage();

    document.querySelector('.nav').addEventListener('click', function(e) {
        const item = e.target.closest('.nav-item');
        if (!item) return;
        const page = item.dataset.page;
        if (page) showPage(page);
    });

    document.getElementById('saveProfile').addEventListener('click', function() {
        let gender = document.querySelector('input[name="gender"]:checked').value;
        let height = parseFloat(document.getElementById('height').value);
        let weight = parseFloat(document.getElementById('weight').value);
        let ckdStage = parseInt(document.getElementById('ckdStage').value);
        let bloodK = parseFloat(document.getElementById('bloodK').value);
        let bloodP = parseFloat(document.getElementById('bloodP').value);
        let edema = document.getElementById('edema').checked;
        if (isNaN(height) || height<100) { alert('è¯·è¾“å…¥æ­£ç¡®èº«é«˜'); return; }
        currentProfile = { gender, height, weight, ckdStage, bloodK, bloodP, edema };
        saveProfile();
        let { target, shares } = computeTargetAndShares(currentProfile);
        currentTarget = target;
        currentShares = shares;
        saveTarget();
        saveShares();

        // ç™¾åº¦ç»Ÿè®¡ï¼šä¿å­˜æ¡£æ¡ˆäº‹ä»¶
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'æ¡£æ¡ˆ', 'ä¿å­˜', `åˆ†æœŸ${ckdStage}`]);
        }

        showPage('target');
    });

    document.getElementById('gotoRecipeFromTarget').addEventListener('click', function() {
        // ç™¾åº¦ç»Ÿè®¡ï¼šç”Ÿæˆé£Ÿè°±
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'é£Ÿè°±', 'ç”Ÿæˆ', 'ä»ç›®æ ‡é¡µ']);
        }
        showPage('recipe');
    });

    document.getElementById('useRecipeForToday').addEventListener('click', function() {
        if (!currentShares) {
            alert('è¯·å…ˆç”Ÿæˆé£Ÿè°±');
            return;
        }
        todayRecord = {
            date: new Date().toLocaleDateString('zh-CN'),
            intake: { ...currentShares }
        };
        saveToday();

        // ç™¾åº¦ç»Ÿè®¡ï¼šä½¿ç”¨é£Ÿè°±è®°å½•ä»Šæ—¥
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'è®°å½•', 'ä½¿ç”¨é£Ÿè°±', '']);
        }

        showPage('record');
    });

    document.getElementById('gotoRecord').addEventListener('click', function() {
        showPage('record');
    });

    document.getElementById('showSliderBtn').addEventListener('click', function() {
        document.getElementById('sliderPanel').style.display = 'block';
        // ç™¾åº¦ç»Ÿè®¡ï¼šæ‰“å¼€è°ƒæ•´é¢æ¿
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'è®°å½•', 'æ‰“å¼€è°ƒæ•´é¢æ¿', '']);
        }
    });

    function setupSlider(sliderId, valId) {
        const slider = document.getElementById(sliderId);
        if (slider) {
            slider.addEventListener('input', function(e) {
                const valSpan = document.getElementById(valId);
                if (valSpan) valSpan.innerText = parseFloat(e.target.value).toFixed(1);
            });
        }
    }
    setupSlider('dairySlider', 'dairyVal');
    setupSlider('meatSlider', 'meatVal');
    setupSlider('vegSlider', 'vegVal');
    setupSlider('fruitSlider', 'fruitVal');
    setupSlider('grainSlider', 'grainVal');
    setupSlider('oilSlider', 'oilVal');
    setupSlider('starchSlider', 'starchVal');

    document.getElementById('saveSlider').addEventListener('click', function() {
        if (!todayRecord) {
            todayRecord = { date: new Date().toLocaleDateString('zh-CN'), intake: {} };
        }
        let newIntake = {
            dairy: parseFloat(document.getElementById('dairySlider')?.value || 0),
            meat: parseFloat(document.getElementById('meatSlider')?.value || 0),
            veg: parseFloat(document.getElementById('vegSlider')?.value || 0),
            fruit: parseFloat(document.getElementById('fruitSlider')?.value || 0),
            grain: parseFloat(document.getElementById('grainSlider')?.value || 0),
            oil: parseFloat(document.getElementById('oilSlider')?.value || 0),
            starch: parseFloat(document.getElementById('starchSlider')?.value || 0)
        };
        todayRecord.intake = newIntake;
        saveToday();
        document.getElementById('sliderPanel').style.display = 'none';
        updateRecordDisplay();

        // ç™¾åº¦ç»Ÿè®¡ï¼šä¿å­˜è°ƒæ•´æ‘„å…¥
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'è®°å½•', 'è°ƒæ•´æ‘„å…¥ä¿å­˜', JSON.stringify(newIntake)]);
        }
    });

    document.getElementById('cancelSlider').addEventListener('click', function() {
        document.getElementById('sliderPanel').style.display = 'none';
        if (todayRecord) {
            let i = todayRecord.intake;
            const sliderMappings = [
                { id: 'dairySlider', valId: 'dairyVal', value: i.dairy },
                { id: 'meatSlider', valId: 'meatVal', value: i.meat },
                { id: 'vegSlider', valId: 'vegVal', value: i.veg },
                { id: 'fruitSlider', valId: 'fruitVal', value: i.fruit },
                { id: 'grainSlider', valId: 'grainVal', value: i.grain },
                { id: 'oilSlider', valId: 'oilVal', value: i.oil },
                { id: 'starchSlider', valId: 'starchVal', value: i.starch }
            ];
            sliderMappings.forEach(item => {
                const slider = document.getElementById(item.id);
                const valSpan = document.getElementById(item.valId);
                if (slider) slider.value = item.value;
                if (valSpan) valSpan.innerText = item.value.toFixed(1);
            });
        }

        // ç™¾åº¦ç»Ÿè®¡ï¼šå–æ¶ˆè°ƒæ•´
        if (typeof _hmt !== 'undefined') {
            _hmt.push(['_trackEvent', 'è®°å½•', 'è°ƒæ•´æ‘„å…¥å–æ¶ˆ', '']);
        }
    });

    if (currentProfile) {
        if (!currentTarget || !currentShares) {
            let { target, shares } = computeTargetAndShares(currentProfile);
            currentTarget = target;
            currentShares = shares;
            saveTarget(); saveShares();
        }
        showPage('target');
    } else {
        showPage('profile');
    }
});
</script>
</body>
</html>